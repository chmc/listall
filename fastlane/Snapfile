# Snapfile for Fastlane Snapshot automation
# Captures automated screenshots for App Store submission

# Path to Xcode project
project "./ListAll/ListAll.xcodeproj"

# List of simulators to use for screenshot generation
# Using iOS 17.5 (available on macos-14 with Xcode 16.1)
# iPhone 15 Pro Max is 6.7" which is acceptable for App Store 6.5" slot
devices([
  "iPhone 15 Pro Max",      # 6.7" display (closest to App Store 6.5" requirement)
  "iPad Pro 13-inch (M4)"   # 13" iPad Pro for App Store screenshots
])

# List of languages to generate screenshots for
# Screenshots will be generated for both English and Finnish
languages([
  "en-US",
  "fi"
])

# The name of the scheme which contains the UI Tests
scheme("ListAll")

# Where should the resulting screenshots be stored?
output_directory("./fastlane/screenshots")

# Clear previous screenshots before generating new ones
clear_previous_screenshots(true)

# Erase simulators before running (built-in fastlane option)
# More reliable than manual xcrun simctl erase in CI
erase_simulator(true)

# Remove the '#' from the image filename
override_status_bar(true)

# Reinstall the app before each test run
reinstall_app(true)

# OPTIMIZATION: Try not erasing simulator between languages
# With reinstall_app(true), app state is fresh anyway
# This may save 2-3 minutes per device by reusing booted simulator
erase_simulator(false)

# Note: test_without_building and derived_data_path are set in Fastfile
# to coordinate with the scan(build_for_testing) prebuild step

# Disable code signing for simulator builds (not needed, prevents hangs)
xcargs("CODE_SIGN_IDENTITY='' CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO")

# Run devices sequentially to avoid signing deadlocks in CI
# Concurrent mode causes keychain access conflicts during code signing
concurrent_simulators(false)

# Generate xcresult bundle for detailed diagnostics (timeline view in Xcode)
# Helps identify where time is spent during test execution
result_bundle(true)

# Increase retry count for CI stability (handles occasional segfaults)
# Snapshot automatically retries on random failures
number_of_retries(2)

# Skip building/running the unit test target entirely
# This prevents hanging at "Touching ListAllTests.xctest" phase
skip_testing(["ListAllTests"])

# Only run the specific screenshot test methods (not all UI tests)
# This ensures fast, deterministic screenshot generation without running CRUD/smoke tests
only_testing([
  "ListAllUITests/testScreenshots01_WelcomeScreen",
  "ListAllUITests/testScreenshots02_MainFlow"
])

# For more information about all available options run
# fastlane action snapshot
