# Snapfile for Fastlane Snapshot automation
# Captures automated screenshots for App Store submission

# Path to Xcode project
project "./ListAll/ListAll.xcodeproj"

# List of simulators to use for screenshot generation
# Using iOS 18.1 to match CI environment (macos-14 with Xcode 16.1)
# iPhone 16 Pro Max is 6.7" which is acceptable for App Store 6.5" slot
# NOTE: Device names vary by Xcode version - CI uses Xcode 16.1 which has iPhone 16 Pro Max (not iPhone 17)
# Fastlane will automatically select iOS 18.1 simulator since it's most common/stable
devices([
  "iPhone 16 Pro Max",      # 6.7" display (closest to App Store 6.5" requirement)
  "iPad Pro 13-inch (M4)"   # 13" iPad Pro for App Store screenshots
])

# List of languages to generate screenshots for
# Screenshots will be generated for both English and Finnish
languages([
  "en-US",
  "fi"
])

# The name of the scheme which contains the UI Tests
scheme("ListAll")

# Where should the resulting screenshots be stored?
output_directory("./fastlane/screenshots")

# Clear previous screenshots before generating new ones
clear_previous_screenshots(true)

# OPTIMIZATION: Don't erase simulator between languages (saves 6-10 minutes)
# With reinstall_app(true), app state is fresh anyway - no need to erase
# Erasing causes full shutdown → erase → reboot cycle per locale
# Benefits: Faster execution, warmer simulator state
# Trade-off: None - reinstall_app provides same cleanliness
erase_simulator(false)

# Remove the '#' from the image filename
override_status_bar(true)

# Reinstall the app before each test run (ensures clean app state)
reinstall_app(true)

# CRITICAL: Set simulator system language to match screenshot language
# This ensures iOS loads the correct .strings bundle BEFORE app launches
# Without this, simulator inherits Finnish from macOS system settings
localize_simulator(true)

# Note: test_without_building and derived_data_path are set in Fastfile
# to coordinate with the scan(build_for_testing) prebuild step

# Disable code signing for simulator builds (not needed, prevents hangs)
# Add test timeout to prevent hung tests from blocking CI for 55+ minutes
# -test-timeouts-enabled YES: Enable test timeouts
# -default-test-execution-time-allowance 300: 5 minutes default per test (increased from 180s)
# -maximum-test-execution-time-allowance 600: 10 minutes max per test (hard limit)
# Note: Tests may need multiple launch retries (3x60s=180s) plus UI waits plus snapshot
xcargs("CODE_SIGN_IDENTITY='' CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO -test-timeouts-enabled YES -default-test-execution-time-allowance 300 -maximum-test-execution-time-allowance 600")

# Run devices sequentially to avoid signing deadlocks in CI
# Concurrent mode causes keychain access conflicts during code signing
concurrent_simulators(false)

# Use result_bundle: false to enable Fastlane log parsing for automatic screenshot extraction
# With xcodebuild_formatter: "" and NSUnbufferedIO=YES, log parsing works correctly with test_without_building
# Fastlane parses NSLog("snapshot: ...") entries from logs to automatically extract screenshots
# NOTE: result_bundle is set to false in Fastfile to ensure log parsing works
# Removing from Snapfile to avoid conflicts - Fastfile override will be used
# result_bundle(false)  # Commented out - controlled by Fastfile

# CRITICAL FIX: Remove Fastlane-level retries, rely on GitHub Actions retry instead
# This prevents double-retry confusion (Fastlane × GitHub Actions = exponential delays)
# GitHub Actions retry is more intelligent and provides better failure isolation
number_of_retries(0)

# Skip building/running the unit test target entirely
# This prevents hanging at "Touching ListAllTests.xctest" phase
skip_testing(["ListAllTests"])

# CRITICAL: Only run the simplified screenshot tests (not the old complex tests)
# This prevents duplicate screenshots from both old and new test classes
only_testing([
  "ListAllUITests/ListAllUITests_Screenshots/testScreenshots01_WelcomeScreen",
  "ListAllUITests/ListAllUITests_Screenshots/testScreenshots02_MainFlow"
])

# For more information about all available options run
# fastlane action snapshot
