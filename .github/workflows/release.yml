name: Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      skip_version_bump:
        description: 'Skip version bump (use current version)'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*'

jobs:
  tests:
    name: Fastlane Tests
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-derived-data-${{ hashFiles('**/ListAll.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-derived-data-

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            ~/Library/Developer/Xcode/DerivedData/*/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Run tests via Fastlane
        run: bundle exec fastlane test

      - name: Upload test results (xcresult)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fastlane-test-results
          path: fastlane/test_output
          retention-days: 14

  beta:
    name: TestFlight (beta)
    # needs: tests
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    runs-on: macos-14
    env:
      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_BASE64: ${{ secrets.ASC_KEY_BASE64 }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      MATCH_GIT_TOKEN: ${{ secrets.MATCH_GIT_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            ~/Library/Developer/Xcode/DerivedData/*/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Prepare Match Git URL with authentication
        run: |
          echo "MATCH_GIT_URL=https://x-access-token:${{ secrets.MATCH_GIT_TOKEN }}@github.com/chmc/listall-signing-certs.git" >> $GITHUB_ENV
          echo "‚úÖ Match Git URL prepared with token authentication"

      - name: Verify Match secrets
        run: |
          if [ -z "${{ secrets.MATCH_PASSWORD }}" ]; then
            echo "‚ùå MATCH_PASSWORD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.MATCH_GIT_TOKEN }}" ]; then
            echo "‚ùå MATCH_GIT_TOKEN secret is not set"
            exit 1
          fi
          echo "‚úÖ Match secrets are configured"

      - name: Show current version
        run: bundle exec fastlane show_version

      - name: Build and upload to TestFlight
        run: |
          if [ "${{ github.event.inputs.skip_version_bump }}" = "true" ]; then
            echo "üì¶ Skipping version bump as requested"
            bundle exec fastlane beta skip_version_bump:true
          elif [ -n "${{ github.event.inputs.bump_type }}" ]; then
            echo "üì¶ Version bump type: ${{ github.event.inputs.bump_type }}"
            bundle exec fastlane beta bump_type:${{ github.event.inputs.bump_type }}
          else
            echo "üì¶ Using default version bump (patch)"
            bundle exec fastlane beta bump_type:patch
          fi

      - name: Show final version
        if: always()
        run: bundle exec fastlane show_version

      - name: Commit version changes
        if: success() && github.event.inputs.skip_version_bump != 'true'
        run: |
          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Get the new version
          NEW_VERSION=$(cat .version)
          
          # Commit version file and project changes
          git add .version ListAll/ListAll.xcodeproj/project.pbxproj
          git commit -m "Bump version to ${NEW_VERSION}" || echo "No changes to commit"
          
          # Create and push tag
          git tag "v${NEW_VERSION}" || echo "Tag already exists"
          
          # Push changes and tags
          git push origin main || echo "Push failed, possibly no changes"
          git push origin "v${NEW_VERSION}" || echo "Tag push failed"
        
      - name: Debug - List identities in keychain
        if: failure()
        run: |
          echo "üîç Checking what's in the keychain..."
          security find-identity -v -p codesigning
          security find-identity -v -p codesigning ~/Library/Keychains/fastlane_tmp_keychain-db || true

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: beta-build-artifacts
          path: |
            ListAll/build/*.ipa
            ListAll/build/*.xcarchive
            ListAll/build/*.log
          retention-days: 14
