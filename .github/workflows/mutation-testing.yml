name: Mutation Testing

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - macos
          - watchos
      muter_args:
        description: 'Extra args for muter run (e.g. --files-to-mutate "path/to/File.swift")'
        required: false
        default: ''
        type: string
  schedule:
    # Weekly: Sunday 2am UTC
    - cron: '0 2 * * 0'

# Muter commit to build from (Homebrew version is broken).
# Update this when a new stable Muter release is verified.
env:
  MUTER_COMMIT: 28f31592fc2779fa69a7c373aaa765106782d70a

jobs:
  #############################################################################
  # Build Muter from source (shared across platform jobs)
  #############################################################################
  build-muter:
    name: Build Muter
    runs-on: macos-14
    timeout-minutes: 15

    steps:
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

    - name: Clone and build Muter
      run: |
        git clone https://github.com/muter-mutation-testing/muter.git /tmp/muter
        cd /tmp/muter
        git checkout ${{ env.MUTER_COMMIT }}
        # --product muter: skip test targets that fail with @testable import in release mode
        swift build -c release --product muter

    - name: Upload Muter binary
      uses: actions/upload-artifact@v4
      with:
        name: muter-binary
        path: /tmp/muter/.build/release/muter
        retention-days: 1

  #############################################################################
  # iOS Mutation Testing — Parallel Shards (one file per shard)
  #############################################################################
  mutation-ios:
    name: Mutate iOS (${{ matrix.file_name }})
    runs-on: macos-14
    needs: build-muter
    if: >-
      github.event.inputs.muter_args == '' &&
      (github.event_name == 'schedule' ||
      github.event.inputs.platform == 'all' ||
      github.event.inputs.platform == 'ios')
    timeout-minutes: 480
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        include:
          - file: "ListAll/ListAll/Models/Item.swift"
            file_name: "Item"
          - file: "ListAll/ListAll/Models/ItemImage.swift"
            file_name: "ItemImage"
          - file: "ListAll/ListAll/Models/List.swift"
            file_name: "List"
          - file: "ListAll/ListAll/Services/ExportService.swift"
            file_name: "ExportService"
          - file: "ListAll/ListAll/Services/ImportService.swift"
            file_name: "ImportService"
          - file: "ListAll/ListAll/Services/SuggestionService.swift"
            file_name: "SuggestionService"
          - file: "ListAll/ListAll/Utils/Constants.swift"
            file_name: "Constants"
          - file: "ListAll/ListAll/Utils/Extensions/String+Extensions.swift"
            file_name: "String+Extensions"
          - file: "ListAll/ListAll/Utils/Helpers/URLHelper.swift"
            file_name: "URLHelper"
          - file: "ListAll/ListAll/Utils/Helpers/ValidationHelper.swift"
            file_name: "ValidationHelper"
          - file: "ListAll/ListAll/Utils/LocalizationManager.swift"
            file_name: "LocalizationManager"
          - file: "ListAll/ListAll/Utils/TooltipManager.swift"
            file_name: "TooltipManager"
          - file: "ListAll/ListAll/ViewModels/ExportViewModel.swift"
            file_name: "ExportViewModel"
          - file: "ListAll/ListAll/ViewModels/ImportViewModel.swift"
            file_name: "ImportViewModel"
          - file: "ListAll/ListAll/ViewModels/ItemViewModel.swift"
            file_name: "ItemViewModel"
          - file: "ListAll/ListAll/ViewModels/ListViewModel.swift"
            file_name: "ListViewModel"
          - file: "ListAll/ListAll/ViewModels/MainViewModel.swift"
            file_name: "MainViewModel"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

    - name: Download Muter binary
      uses: actions/download-artifact@v4
      with:
        name: muter-binary
        path: /usr/local/bin

    - name: Make Muter executable
      run: chmod +x /usr/local/bin/muter

    - name: Clean simulator state
      run: |
        xcrun simctl shutdown all || true
        xcrun simctl delete unavailable || true

    - name: Measure baseline test runtime
      if: matrix.file_name == 'Item'
      run: |
        echo "::group::Baseline test suite timing"
        SIM_UDID=$(xcrun simctl list devices available -j | python3 -c "
        import json, sys
        data = json.load(sys.stdin)
        for rt, devs in sorted(data.get('devices', {}).items(), reverse=True):
            if 'iOS' in rt:
                for d in devs:
                    if d.get('isAvailable') and 'iPhone 16 Pro' in d.get('name', ''):
                        print(d['udid']); sys.exit(0)
        sys.exit(1)")
        START=$(date +%s)
        xcodebuild test \
          -project ListAll/ListAll.xcodeproj \
          -scheme ListAll \
          -destination "platform=iOS Simulator,id=${SIM_UDID}" \
          -only-testing:ListAllTests \
          -quiet 2>&1 || true
        END=$(date +%s)
        ELAPSED=$((END - START))
        echo "::notice::Baseline iOS test suite runtime: ${ELAPSED}s ($(( ELAPSED / 60 ))m$(( ELAPSED % 60 ))s)"
        echo "::endgroup::"

    - name: Run Muter (iOS)
      run: |
        chmod +x scripts/run-muter.sh
        script -q muter-output.log ./scripts/run-muter.sh ios --files-to-mutate "${{ matrix.file }}"

    - name: Upload mutation report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mutation-report-ios-${{ matrix.file_name }}-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          muter-report.json
          muter-report.html
          muter-output.log
        retention-days: 90

  #############################################################################
  # iOS Mutation Testing — Manual Override (single job, custom muter_args)
  #############################################################################
  mutation-ios-manual:
    name: Mutate iOS (manual)
    runs-on: macos-14
    needs: build-muter
    if: >-
      github.event.inputs.muter_args != '' &&
      (github.event.inputs.platform == 'all' ||
      github.event.inputs.platform == 'ios')
    timeout-minutes: 480

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

    - name: Download Muter binary
      uses: actions/download-artifact@v4
      with:
        name: muter-binary
        path: /usr/local/bin

    - name: Make Muter executable
      run: chmod +x /usr/local/bin/muter

    - name: Clean simulator state
      run: |
        xcrun simctl shutdown all || true
        xcrun simctl delete unavailable || true

    - name: Run Muter (iOS)
      run: |
        chmod +x scripts/run-muter.sh
        script -q muter-output.log ./scripts/run-muter.sh ios ${{ github.event.inputs.muter_args }}

    - name: Upload mutation report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mutation-report-ios-manual-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          muter-report.json
          muter-report.html
          muter-output.log
        retention-days: 90

  #############################################################################
  # macOS Mutation Testing — Parallel Shards (one file per shard)
  #############################################################################
  mutation-macos:
    name: Mutate macOS (${{ matrix.file_name }})
    runs-on: macos-14
    needs: build-muter
    if: >-
      github.event.inputs.muter_args == '' &&
      (github.event_name == 'schedule' ||
      github.event.inputs.platform == 'all' ||
      github.event.inputs.platform == 'macos')
    timeout-minutes: 480
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        include:
          # Shared files (same as iOS)
          - file: "ListAll/ListAll/Models/Item.swift"
            file_name: "Item"
          - file: "ListAll/ListAll/Models/ItemImage.swift"
            file_name: "ItemImage"
          - file: "ListAll/ListAll/Models/List.swift"
            file_name: "List"
          - file: "ListAll/ListAll/Services/ExportService.swift"
            file_name: "ExportService"
          - file: "ListAll/ListAll/Services/ImportService.swift"
            file_name: "ImportService"
          - file: "ListAll/ListAll/Services/SuggestionService.swift"
            file_name: "SuggestionService"
          - file: "ListAll/ListAll/Utils/Constants.swift"
            file_name: "Constants"
          - file: "ListAll/ListAll/Utils/Extensions/String+Extensions.swift"
            file_name: "String+Extensions"
          - file: "ListAll/ListAll/Utils/Helpers/URLHelper.swift"
            file_name: "URLHelper"
          - file: "ListAll/ListAll/Utils/Helpers/ValidationHelper.swift"
            file_name: "ValidationHelper"
          - file: "ListAll/ListAll/Utils/LocalizationManager.swift"
            file_name: "LocalizationManager"
          - file: "ListAll/ListAll/Utils/TooltipManager.swift"
            file_name: "TooltipManager"
          - file: "ListAll/ListAll/ViewModels/ExportViewModel.swift"
            file_name: "ExportViewModel"
          - file: "ListAll/ListAll/ViewModels/ImportViewModel.swift"
            file_name: "ImportViewModel"
          - file: "ListAll/ListAll/ViewModels/ItemViewModel.swift"
            file_name: "ItemViewModel"
          - file: "ListAll/ListAll/ViewModels/ListViewModel.swift"
            file_name: "ListViewModel"
          - file: "ListAll/ListAll/ViewModels/MainViewModel.swift"
            file_name: "MainViewModel"
          # macOS-specific files
          - file: "ListAll/ListAllMac/Commands/AppCommands.swift"
            file_name: "AppCommands"
          - file: "ListAll/ListAllMac/Services/ServicesProvider.swift"
            file_name: "ServicesProvider"
          - file: "ListAll/ListAllMac/Utils/MacTooltipManager.swift"
            file_name: "MacTooltipManager"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

    - name: Download Muter binary
      uses: actions/download-artifact@v4
      with:
        name: muter-binary
        path: /usr/local/bin

    - name: Make Muter executable
      run: chmod +x /usr/local/bin/muter

    - name: Run Muter (macOS)
      run: |
        chmod +x scripts/run-muter.sh
        script -q muter-output.log ./scripts/run-muter.sh macos --files-to-mutate "${{ matrix.file }}"

    - name: Upload mutation report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mutation-report-macos-${{ matrix.file_name }}-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          muter-report.json
          muter-report.html
          muter-output.log
        retention-days: 90

  #############################################################################
  # macOS Mutation Testing — Manual Override (single job, custom muter_args)
  #############################################################################
  mutation-macos-manual:
    name: Mutate macOS (manual)
    runs-on: macos-14
    needs: build-muter
    if: >-
      github.event.inputs.muter_args != '' &&
      (github.event.inputs.platform == 'all' ||
      github.event.inputs.platform == 'macos')
    timeout-minutes: 480

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

    - name: Download Muter binary
      uses: actions/download-artifact@v4
      with:
        name: muter-binary
        path: /usr/local/bin

    - name: Make Muter executable
      run: chmod +x /usr/local/bin/muter

    - name: Run Muter (macOS)
      run: |
        chmod +x scripts/run-muter.sh
        script -q muter-output.log ./scripts/run-muter.sh macos ${{ github.event.inputs.muter_args }}

    - name: Upload mutation report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mutation-report-macos-manual-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          muter-report.json
          muter-report.html
          muter-output.log
        retention-days: 90

  #############################################################################
  # watchOS Mutation Testing (single job — fewer files)
  #############################################################################
  mutation-watchos:
    name: Mutate watchOS
    runs-on: macos-14
    needs: build-muter
    if: >-
      github.event_name == 'schedule' ||
      github.event.inputs.platform == 'all' ||
      github.event.inputs.platform == 'watchos'
    timeout-minutes: 180

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

    - name: Download Muter binary
      uses: actions/download-artifact@v4
      with:
        name: muter-binary
        path: /usr/local/bin

    - name: Make Muter executable
      run: chmod +x /usr/local/bin/muter

    - name: Clean simulator state
      run: |
        xcrun simctl shutdown all || true
        xcrun simctl delete unavailable || true

    - name: Run Muter (watchOS)
      run: |
        chmod +x scripts/run-muter.sh
        script -q muter-output.log ./scripts/run-muter.sh watchos ${{ github.event.inputs.muter_args }}

    - name: Upload mutation report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mutation-report-watchos-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          muter-report.json
          muter-report.html
          muter-output.log
        retention-days: 90
